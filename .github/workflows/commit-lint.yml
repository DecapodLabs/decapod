name: Commit Lint

on:
  push:
  pull_request:
    branches: [ master ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Commit Messages
        run: |
          # Define the allowed prefixes
          # Standard Conventional Commits: feat, fix, chore, ci, docs, style, refactor, perf, test
          REGEX="^(feat|fix|chore|ci|docs|style|refactor|perf|test)(\(.*\))?!?: .+"
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Check all commits in the PR
            COMMITS=$(git log --format=%s origin/${{ github.base_ref }}..HEAD)
          else
            # Check the commits in the push (up to 20 for brevity)
            COMMITS=$(git log --format=%s -n 20)
          fi

          echo "Checking commit messages..."
          FAILED=0
          while IFS= read -line commit; do
            if [[ ! $commit =~ $REGEX ]]; then
              echo "❌ Invalid commit message: '$commit'"
              echo "   Must start with: feat:, fix:, chore:, ci:, docs:, style:, refactor:, perf:, or test:"
              FAILED=1
            else
              echo "✅ Valid: '$commit'"
            fi
          done <<< "$COMMITS"

          if [ $FAILED -ne 0 ]; then
            exit 1
          fi
