name: Publish to Crates.io

on:
  release:
    types: [published]

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    if: github.repository == 'DecapodLabs/decapod'
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Build & Guardrail
        run: |
          # Version Mismatch Gate
          VERSION=$(grep '^version =' Cargo.toml | head -n 1 | cut -d '"' -f 2)
          TAG=${{ github.event.release.tag_name }}
          TAG_CLEAN=${TAG#v}
          if [ "$VERSION" != "$TAG_CLEAN" ]; then
            echo "Error: Version mismatch! Cargo.toml=$VERSION vs Release Tag=$TAG_CLEAN"
            exit 1
          fi

          cargo build --release
          
          # Sanity Gate
          ./target/release/decapod docs list | grep "docs/DECAPOD.md"
          echo "Guardrails passed."

      - name: Publish
        run: cargo publish --locked
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
