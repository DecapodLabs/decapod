name: Publish to Crates.io

on:
  release:
    types: [published]
  workflow_dispatch: # Allows manual trigger for testing or emergency

jobs:
  publish:
    name: Package & Publish
    runs-on: ubuntu-latest
    if: github.repository == 'DecapodLabs/decapod'
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Enforcement Gate Description Check
        run: bash scripts/check_crate_description.sh

      - name: Enforcement Gate Version Match
        run: |
          VERSION=$(grep '^version =' Cargo.toml | head -n 1 | cut -d '"' -f 2)
          TAG=${{ github.event.release.tag_name }}
          if [ -n "$TAG" ]; then
            TAG_CLEAN=${TAG#v}
            if [ "$VERSION" != "$TAG_CLEAN" ]; then
              echo "Error: Version mismatch! Cargo.toml=$VERSION vs Release Tag=$TAG_CLEAN"
              exit 1
            fi
          fi

      - name: Sanity Gate
        run: |
          cargo build --release
          ./target/release/decapod docs list | grep "embedded/core/DECAPOD.md"
          echo "Guardrails passed."

      - name: Dry Run
        run: cargo publish --dry-run --locked

      - name: Publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish --locked
